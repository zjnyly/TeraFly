# Websockets传送格式

## 流程

1. 网页端发起Websocket连接
2. 连接成功后，服务器等待网页输入内容
3. 网页收到输入的内容，向服务器发送**聊天输入数据包**，服务器返回**回应起始数据包**开始回应
4. 服务器推理输入的内容，随着推理不断向网页发送**回应数据包**，网页收到**回应数据包**后返回**确认数据包**
5. 服务器推理到EOF，向网页发送**回应结束数据包**，网页收到**回应结束数据包**后返回**确认数据包**
6. 完成一次推理，返回第3步

- 注意：服务端应当在收到**确认数据包**后才能继续发送下一个数据。可以在服务端设置超时逻辑，超过一定时间没有收到则可以断开连接

## 数据包格式

### 聊天输入数据包

聊天输入数据包由网页向服务器发送。

```json
{
    "type": "input",
    "content": "<聊天输入内容>"
}
```

### 回应起始数据包

回应起始数据包由服务器向网页发送。

```json
{
    "type": "responseStart",
    "displayName": "<聊天泡泡显示名称>",
    "avatarType": "<头像类型>"
}
```

- **头像类型**：可以为gpu、fpga或cpu，网页端根据该类型显示头像

### 回应数据包

回应数据包由服务器向网页发送。网页收到后将把回应内容附加到聊天泡泡的末尾。

```json
{
    "type": "response",
    "content": "<回应内容>"
}
```

### 回应结束数据包

回应结束数据包由服务器向网页发送。包含延迟信息。

```json
{
    "type": "responseEnd",
    "latency": "<延迟信息>"
}
```

- **延迟信息**：包含本次回应的延迟信息，可以是文字或者其他，可以后面再定

### 确认数据包

确认数据包由网页向服务器发送。

```json
{
    "type": "acknowledge",
    "originalType": "<收到的数据包的type字段>"
}
```

- 举例：网页如果收到了回应结束数据包，则返回：

  ```json
  {
      "type": "acknowledge",
      "originalType": "responseEnd"
  }
  ```
